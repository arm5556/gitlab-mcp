# GitLab MCP Server - Claude AI Context

> **📝 Documentation Source**: This file is automatically generated from the master documentation in `.cursor/rules/gitlab-mcp-context.mdc` and `.cursor/rules/mcp-tools-reference.mdc`. All updates should be made to those files first, then copied here.

## Repository Overview
This is an **AI-optimized Model Context Protocol (MCP) Server** for GitLab integration. Originally designed for Merge Request management, it has been **extended with 3 new issue management tools** to provide comprehensive GitLab workflow automation.

## Why This Fork is AI-Optimized 🧠

- **🎯 Essential Tools Only**: 9 carefully selected tools vs 40+ scattered operations
- **⚡ Performance Optimized**: 65-80% faster responses with streamlined schemas
- **🔍 Smart Filtering**: Only unresolved discussions, not resolved noise
- **🏗️ Clean Architecture**: 85% code reduction (3,490 → ~500 lines) with modular structure
- **📊 Enhanced Data**: Vulnerability location, CVE details, upgrade instructions
- **🐛 Bug Fixes**: npx compatibility, error handling, new GraphQL endpoints

## 🏗️ Modular Architecture (AI-Friendly)

```
src/
├── index.ts              # Main entry point (~9 lines)
├── server.ts             # MCP server setup (~100 lines)
├── config/
│   └── gitlab.ts         # GitLab configuration and environment setup
├── utils/
│   ├── errors.ts         # Error handling utilities
│   ├── validation.ts     # Token validation
│   ├── pagination.ts     # Pagination utilities
│   └── index.ts          # Re-exports
├── api/
│   ├── merge-requests.ts # MR-related API calls (4 tools)
│   ├── vulnerabilities.ts# Enhanced GraphQL vulnerability API
│   ├── pipelines.ts      # Test report API calls
│   ├── issues.ts         # **NEW** Issue API functions (3 tools)
│   └── index.ts          # Re-exports all API functions
├── tools/
│   ├── definitions.ts    # Tool definitions (9 tools only)
│   ├── handlers.ts       # Tool request handlers
│   └── index.ts          # Re-exports
└── schemas/
    ├── base.ts           # Common base schemas
    ├── merge-requests.ts # MR schemas (optimized)
    ├── discussions.ts    # Discussion schemas (optimized)
    ├── vulnerabilities.ts# Enhanced GraphQL vulnerability schemas
    ├── test-reports.ts   # Pipeline test report schemas
    ├── issues.ts         # **NEW** Issue schemas
    └── index.ts          # Re-exports all schemas
```

**Benefits for AI Agents:**
- **Focused modules** - Each file handles one specific domain
- **Smaller files** - Better for LLM context processing
- **Type-safe** - Full TypeScript support with clean imports
- **Performance optimized** - Streamlined responses for faster processing

## 🛠️ Essential Tools (9 Total)

### Merge Request Tools (4)
1. **`get_merge_request`** - Get MR metadata (supports IID or branch name)
2. **`get_mr_discussions`** - List **unresolved** diff discussions only
3. **`create_merge_request_note`** - Add replies to MR threads
4. **`update_merge_request`** - Update MR properties including labels

### Issue Management Tools (3) - **NEWLY ADDED**
5. **`create_issue`** - Create new issues with title, description, assignees, labels
6. **`get_issue`** - Get details of specific issue by IID
7. **`update_issue`** - Update existing issues (title, description, state, etc.)

### Vulnerability & Testing Tools (2)
8. **`get_vulnerabilities_by_ids`** - Enhanced GraphQL vulnerability data
9. **`get_failed_test_cases`** - Pipeline test report analysis

## 🎯 AI-Optimized Tool Details

### `get_merge_request` 📋 **PRIMARY MR TOOL**
**Purpose**: Fetch merge request details with optimized response format

**Parameters**:
- `project_id` (string) - Project ID or URL-encoded path
- `merge_request_iid` (number, optional) - MR internal ID
- `source_branch` (string, optional) - Source branch name

**Usage**: Either `merge_request_iid` OR `source_branch` must be provided

**AI-Optimized Response** (22 essential fields vs 33+ full GitLab response):
- ✅ Core data: `id`, `iid`, `title`, `state`, `source_branch`, `target_branch`
- ✅ Simplified author: `{ username: "johndoe" }` (not full profile)
- ✅ Essential metadata: `web_url`, `labels`, `created_at`, `updated_at`
- ✅ Pipeline status: `head_pipeline.status`
- ❌ Removed: avatar URLs, diff refs, collaboration flags, SHA hashes

### `get_mr_discussions` 💬 **CODE REVIEW TOOL**
**Purpose**: List **unresolved** diff discussions for code review responses

**Parameters**:
- `project_id` (string) - Project ID or URL-encoded path  
- `merge_request_iid` (number) - MR internal ID

**Smart Filtering**: Returns **only unresolved diff notes** (DiffNote type, resolvable=true, resolved=false)

**AI-Optimized Response** (7 essential fields vs 20+ full GitLab response):
- ✅ Discussion ID: For replying to threads
- ✅ Comment body: The actual review comment
- ✅ Author username: Who made the comment
- ✅ File location: `position.new_path` and `position.new_line`
- ✅ Resolution status: `resolvable`, `resolved`
- ❌ Removed: User profiles, SHA hashes, complex line ranges, system metadata

### `create_merge_request_note` ✍️ **REPLY TOOL**
**Purpose**: Add a reply note to an existing merge request thread

**Parameters**:
- `project_id` (string) - Project ID or URL-encoded path
- `merge_request_iid` (number) - MR internal ID
- `discussion_id` (string) - The ID of the thread to reply to
- `body` (string) - The content of the note or reply
- `created_at` (string, optional) - Date the note was created at (ISO 8601 format)

### `update_merge_request` 🏷️ **MR MANAGEMENT TOOL**
**Purpose**: Update merge request properties including adding labels

**Parameters**:
- `project_id` (string) - Project ID or URL-encoded path
- `merge_request_iid` (number, optional) - MR internal ID
- `source_branch` (string, optional) - Source branch name
- `title` (string, optional) - MR title
- `description` (string, optional) - MR description
- `labels` (array, optional) - Labels to add/update
- `assignee_ids` (array, optional) - User IDs to assign
- `state_event` (string, optional) - "close" or "reopen"
- `target_branch` (string, optional) - Target branch
- `remove_source_branch` (boolean, optional) - Remove source branch after merge
- `squash` (boolean, optional) - Squash commits when merging
- `draft` (boolean, optional) - Mark as work in progress

### `create_issue` 🆕 **NEW ISSUE TOOL**
**Purpose**: Create a new issue in a GitLab project

**Parameters**:
```typescript
{
  project_id: string,
  title: string,
  description?: string,
  assignee_ids?: number[],
  labels?: string[],
  milestone_id?: number
}
```

### `get_issue` 🔍 **GET ISSUE TOOL**
**Purpose**: Get details of a specific issue by its IID

**Parameters**:
```typescript
{
  project_id: string,
  issue_iid: number
}
```

### `update_issue` ✏️ **UPDATE ISSUE TOOL**
**Purpose**: Update an existing issue

**Parameters**:
```typescript
{
  project_id: string,
  issue_iid: number,
  title?: string,
  description?: string,
  assignee_ids?: number[],
  labels?: string[],
  milestone_id?: number,
  state_event?: "close" | "reopen",
  weight?: number,
  due_date?: string,
  confidential?: boolean,
  discussion_locked?: boolean
}
```

### `get_vulnerabilities_by_ids` 🔍 **ENHANCED VULNERABILITY TOOL**
**Purpose**: Fetch detailed vulnerability information with enhanced location and solution data

**Parameters**:
- `project_id` (string) - Project ID or URL-encoded path
- `vulnerability_ids` (array) - Array of vulnerability IDs (numeric parts only)

**Enhanced GraphQL Data Returned**:
- **📍 Location**: File path, line numbers, package name and version
- **🔧 Solution**: Upgrade instructions with specific version recommendations
- **🆔 Identifiers**: CVE numbers, external references with URLs
- **🔍 Scanner**: Scanner name and vendor information

### `get_failed_test_cases` 🧪 **PIPELINE ANALYSIS TOOL**
**Purpose**: Get failed test cases from a pipeline's test report

**Parameters**:
- `project_id` (string) - Project ID or URL-encoded path
- `pipeline_id` (number) - The ID of the pipeline

## Performance Optimizations ⚡

### Task 1.1: JSON Pretty-Printing Removed (+30% speed)
```typescript
// Before (slow)
text: JSON.stringify(data, null, 2)

// After (fast)  
text: JSON.stringify(data)
```

### Task 1.2: Streamlined Response Format (+50% speed)
```typescript
// Optimized MR Response (22 fields vs 33+)
export const OptimizedGitLabMergeRequestSchema = z.object({
  id: z.number(),
  iid: z.number(),
  title: z.string(),
  state: z.string(),
  source_branch: z.string(),
  target_branch: z.string(),
  author: z.object({ username: z.string() }),
  // ... only essential fields
});
```

### Task 1.3: Discussion Optimization (+65% speed)
```typescript
// Optimized Discussion Response (7 fields vs 20+)
export const OptimizedGitLabDiscussionNoteSchema = z.object({
  id: z.number(),
  body: z.string(),
  author: z.object({ username: z.string() }),
  position: z.object({
    new_path: z.string(),
    new_line: z.number().nullable(),
  }).optional(),
  // ... only code review essentials
});
```

## 🤖 AI Workflow Patterns

### Complete Code Review Workflow
```typescript
// 1. Get MR by branch name
const mr = await tools.get_merge_request({
  project_id: "my-project",
  source_branch: "feature/new-api"
});

// 2. Get unresolved discussions
const discussions = await tools.get_mr_discussions({
  project_id: "my-project",
  merge_request_iid: mr.iid
});

// 3. Process each unresolved comment
for (const discussion of discussions) {
  const note = discussion.notes[0];
  const filePath = note.position?.new_path;
  const lineNumber = note.position?.new_line;
  const reviewComment = note.body;
  
  // AI generates appropriate response
  const response = generateCodeReviewResponse(reviewComment, filePath, lineNumber);
  
  // 4. Reply to the discussion
  await tools.create_merge_request_note({
    project_id: "my-project",
    merge_request_iid: mr.iid,
    discussion_id: discussion.id,
    body: response
  });
}

// 5. Update MR labels when all comments addressed
await tools.update_merge_request({
  project_id: "my-project",
  merge_request_iid: mr.iid,
  labels: ["reviewed", "comments-addressed", "ready-for-merge"]
});
```

### Issue Management Workflow
```typescript
// 1. Create a new issue
const issue = await tools.create_issue({
  project_id: "my-project",
  title: "Fix authentication bug",
  description: "Users cannot login with special characters in password",
  assignee_ids: [12345],
  labels: ["bug", "authentication", "priority-high"],
  milestone_id: 67
});

// 2. Get issue details
const issueDetails = await tools.get_issue({
  project_id: "my-project",
  issue_iid: issue.iid
});

// 3. Update issue status after fix
await tools.update_issue({
  project_id: "my-project",
  issue_iid: issue.iid,
  labels: ["bug", "authentication", "priority-high", "fixed"],
  state_event: "close"
});
```

### Vulnerability Remediation Workflow
```typescript
// 1. Get vulnerability details with precise location
const vulnerabilities = await tools.get_vulnerabilities_by_ids({
  project_id: "my-project",
  vulnerability_ids: ["12345", "67890"]
});

// 2. Process each vulnerability
for (const vuln of vulnerabilities) {
  const filePath = vuln.location?.file;
  const packageName = vuln.location?.dependency?.package?.name;
  const currentVersion = vuln.location?.dependency?.version;
  const solution = vuln.solution;
  const cves = vuln.identifiers?.filter(id => id.externalType === 'cve');
  
  // AI can provide precise remediation steps
  console.log(`Fix ${packageName} in ${filePath}: ${solution}`);
}
```

## Schema Organization (Two-Stage Architecture)

### Validation + Optimization Pattern
```typescript
// Stage 1: Validate full GitLab response (safety)
const fullMR = GitLabMergeRequestSchema.parse(apiResponse);

// Stage 2: Transform to optimized format (performance)
const optimizedMR = streamlineMergeRequest(fullMR);
```

### Schema Files
- **`base.ts`** - Common schemas (GitLabUserSchema, etc.)
- **`merge-requests.ts`** - MR schemas (full + optimized)
- **`discussions.ts`** - Discussion schemas (full + optimized)
- **`vulnerabilities.ts`** - Enhanced GraphQL vulnerability schemas
- **`test-reports.ts`** - Pipeline test report schemas
- **`issues.ts`** - **NEW** Issue schemas

## Important Patterns & Conventions

### Function Naming
- API functions: `camelCase` (e.g., `getMergeRequest`, `listMergeRequestDiscussions`)
- Tool names: `snake_case` (e.g., `get_merge_request`, `get_mr_discussions`)
- Schema names: `PascalCase` + `Schema` suffix (e.g., `OptimizedGitLabMergeRequestSchema`)

### Error Handling
```typescript
// Always use this pattern for GitLab API calls
await handleGitLabError(response);
const data = await response.json();
return SchemaName.parse(data);
```

### Project ID Handling
```typescript
// Always decode project IDs first
projectId = decodeURIComponent(projectId);
const url = `${GITLAB_API_URL}/projects/${encodeURIComponent(projectId)}/...`;
```

### Token Validation
```typescript
// Add to functions that require authentication
validateGitLabToken();
```

## GitLab API Specifics

### Authentication
- Uses `PRIVATE-TOKEN` header with personal access token
- Environment variable: `GITLAB_PERSONAL_ACCESS_TOKEN`
- Validate token availability before API calls

### API Endpoints
- **REST API**: `${GITLAB_API_URL}/api/v4/...`
- **GraphQL API**: `${GITLAB_API_URL}/api/graphql`
- URL normalization handles various input formats

### Rate Limiting
- Handle 403 errors with rate limit messages
- Implemented in `handleGitLabError` function

## Configuration

### Environment Variables
- `GITLAB_API_URL` - GitLab instance URL (defaults to gitlab.com)
- `GITLAB_PERSONAL_ACCESS_TOKEN` - Authentication token
- `GITLAB_READ_ONLY_MODE` - Filter to read-only tools when set to 'true'

### Build & Deployment
```bash
npm run build          # Compile TypeScript
npm run watch          # Watch mode for development
node build/src/index.js    # Run MCP server
```

## Read-Only vs Write Operations

### Read-Only Tools (Safe for exploration) - 5 Tools
- `get_merge_request` - Fetch MR information
- `get_mr_discussions` - List unresolved discussions 
- `get_vulnerabilities_by_ids` - Get vulnerability data
- `get_failed_test_cases` - Get test failure data
- `get_issue` - **NEW** - Get issue information

### Write Tools (Require caution) - 4 Tools
- `create_merge_request_note` - Adds comments/replies
- `update_merge_request` - Modifies MR properties
- `create_issue` - **NEW** - Creates new issues
- `update_issue` - **NEW** - Modifies issue properties

## Development Workflow

### Adding New Tools
1. Define schema in appropriate `schemas/` file
2. Add tool definition to `tools/definitions.ts`
3. Implement API function in appropriate `api/` file
4. Add case handler in `tools/handlers.ts`
5. Update exports in `index.ts` files
6. Create tests in `tests/` subdirectory

### Schema Development
1. Create both full and optimized schemas
2. Add transformer function (e.g., `streamlineMergeRequest`)
3. Export TypeScript types using `z.infer<typeof SchemaName>`
4. Use full schema for validation, optimized for responses

## Common Pitfalls & Solutions

### GraphQL Vulnerabilities
- Use union type fragments for location data
- Field names differ from REST API (`externalType` vs `type`)
- Some fields may be union types that can't be queried directly

### URL Encoding
- Always decode project IDs: `decodeURIComponent(projectId)`
- Always encode for URLs: `encodeURIComponent(projectId)`
- Handle special characters in project paths

### Schema Validation
- Always parse responses through Zod schemas
- Handle validation errors gracefully
- Use `.optional()` for fields that might be null/undefined

## Best Practices for AI Agents

1. **Use Optimized Tools**: All 9 tools return streamlined, AI-friendly data
2. **Handle Arrays**: Single IDs should be passed as arrays: `["12345"]`
3. **Check Schemas**: Reference schema descriptions for required fields
4. **Error Context**: Include project context when errors occur
5. **Batch Operations**: Use tools that support multiple items when possible
6. **Focus on Unresolved**: `get_mr_discussions` only returns unresolved items
7. **Use Branch Names**: More intuitive than MR IIDs for development workflow
8. **Issue Workflow Integration**: Combine issue and MR tools for complete project management

## Error Handling & Best Practices

### Common Error Cases
1. **Invalid Token**: `GITLAB_PERSONAL_ACCESS_TOKEN` not set or expired
2. **Project Not Found**: Invalid `project_id` or insufficient permissions
3. **MR Not Found**: Invalid `merge_request_iid` or `source_branch`
4. **Issue Not Found**: Invalid `issue_iid` or insufficient permissions
5. **Rate Limiting**: Too many API requests (403 with rate limit message)
6. **Vulnerability Not Found**: Invalid `vulnerability_ids` or access denied

### AI Agent Best Practices
- **Use branch names**: More intuitive than MR IIDs for development workflow
- **Batch vulnerability requests**: Multiple IDs in one call for efficiency
- **Handle optional fields**: Many fields may be null (use optional chaining)
- **Provide context**: Include project and MR context in error messages
- **Focus on unresolved**: `get_mr_discussions` automatically filters to unresolved only
- **Issue management**: Use issue tools for bug tracking and feature requests

## MCP Integration Notes

- Server implements MCP protocol version 2024-11-05
- Tools use JSON Schema for validation (converted from Zod)
- Supports both stdio and custom transport methods
- Compatible with various MCP clients and AI agents
- Optimized for Claude, Cursor, Cline, and other AI development tools

## Recent Changes (Issue Management Addition)

### New Files Added
- `src/api/issues.ts` - Issue API functions (create, get, update)
- `src/schemas/issues.ts` - Issue-related Zod schemas and types

### Modified Files
- `src/tools/definitions.ts` - Added 3 new issue tool definitions
- `src/tools/handlers.ts` - Added handlers for issue tools
- `src/api/index.ts` - Export new issue API functions
- `src/schemas/index.ts` - Export new issue schemas
- `src/server.ts` - Updated comments to reflect 9 tools

### Performance Benefits ⚡

#### Response Size Optimizations
- **MR responses**: 49.6% smaller (1,408 → 710 characters)
- **Discussion responses**: 64.8% smaller (1,126 → 396 characters)
- **Combined performance**: 65-80% faster than original

#### AI Processing Benefits
- **Focused data**: Only essential fields for decision-making
- **Faster parsing**: Fewer fields to process
- **Better context**: Optimized for LLM token efficiency
- **Reduced noise**: No unnecessary metadata or system fields

---

> **⚠️ Important**: This file is a copy of the master documentation in `.cursor/rules/`. When making updates, please modify the source files first, then copy the content here to maintain consistency.